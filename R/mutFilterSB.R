#' mutFilterSB
#' @description Filter variants based on strand bias.
#'
#' @param maf An MAF object, generated by \code{\link{vcfToMAF}} function.
#' @param tumorSampleName Label of the tumor sample, should be one of the 
#' column names of maf. If it is set as 'Extracted', tumorSampleName would be
#' extracted automatically from the maf data frame. Default: 'Extracted'.
#' @param method Method will be used to detect strand bias, 
#' including 'SOR' and 'Fisher'. Default: 'SOR'.
#' @param threshold Cutoff strand bias value will be used to filter variants.
#' Default: 3
#'

mutFilterSB <- function(maf, tumorSampleName = 'Extracted', 
                        method = 'SOR', threshold = 3) {
  withSB <- grep('SB', maf$FORMAT)
  message(paste0(length(withSB), 
                 ' row(s) of information have SB information.'))
  
  ## get tumorSampleName and normalSampleName
  if (tumorSampleName == 'Extracted'){
    tumorSampleName <- unique(maf$Tumor_Sample_Barcode)
  } else if(!(tumorSampleName %in% colnames(maf))) {
    stop('Invaild tumorSampleName.')
  }
  
  discard <- c()
  # use for loop to get the SB score for each variation
  for (i in 1:nrow(maf)){
    if (i %in% withSB) {
      SBindex <- strsplit(maf$FORMAT[i], ':')[[1]] == 'SB'
      SBcharmatix <- strsplit(maf[i, tumorSampleName], 
                              ':')[[1]][SBindex]
      if (SBscore(SBcharmatix, method) > threshold) {
        discard <- c(discard, i)
      }
    }
  }
  
  
  if (is.null(discard)){
    return(maf)
  }else {
    maf_filtered <- maf[-discard, ]
    rownames(maf_filtered) <- 1:nrow(maf_filtered)
    return(maf_filtered)
  }
}

## construct function to calculate the SB score for strand bias detection
SBscore <- function(charmatrix, method = 'SOR'){
  depths <- as.numeric(strsplit(charmatrix, ",")[[1]])
  refFw <- depths[1] + 1
  refRv <- depths[2] + 1
  altFw <- depths[3] + 1
  altRv <- depths[4] + 1
  
  if (method == 'SOR') {
    symmetricalRatio <- (refFw * altRv)/(refRv * altFw) + 
      (refRv * altFw) / (refFw * altRv)
    
    refRatio <- refRv / refFw
    altRatio <- altFw / altRv
    score <- log(symmetricalRatio) + log(refRatio) - log(altRatio)
    
  }else if (method == 'Fisher')   {
    matrix <- rbind(c(refFw, refRv), c(altFw, altRv))
    score <- 1 - fisher.test(matrix)$p.value 
  }else {
    stop('Please select a method from SOR and Fisher')
  }
  
  return(score)
}
