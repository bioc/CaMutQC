#' mutFilterNormalDP
#' @description Filter dbsnp/non-dbsnp variants based on their normal depth
#'
#' @param maf An MAF data frame, generated by \code{\link{vcfToMAF}} function.
#' @param normalSampleName Label of the normal sample, should be one of the 
#' column names of maf. If it is set as 'Extracted', normalSampleName would be
#' extracted automatically from the maf data frame. Default: 'Extracted'.
#' 
#' @return An MAF data frame after filtering for Normal depth.

mutFilterNormalDP <- function(maf, normalSampleName = 'Extracted') {
  if (!('Existing_variation' %in% colnames(maf))) {
    stop('No annotation from existing database detected.')
  }
  
  if (normalSampleName == 'Extracted'){
    normalSampleName <- unique(maf$Matched_Norm_Sample_Barcode)
  }else if(!(normalSampleName %in% colnames(maf))) {
    stop('Invaild normalSampleName.')
  }
  
  # build a vector to store discarded variants
  discard <- c()
  
  for (i in 1:nrow(maf)) {
    nDP_loc <- strsplit(maf[i, 'FORMAT'], ":")[[1]] == 'DP'
    nDP <- as.numeric(strsplit(maf[i, normalSampleName], ":")[[1]][nDP_loc])
    
    # variants in dbsnp
    if(length(grep('rs', maf[, 'Existing_variation'])) != 0) {
      if(nDP < 19) {
        discard <- c(discard, i)
      }
      
      # variants not in dbsnp
    }else if (nDP < 8) {
      discard <- c(discard, i)
    } 
 }
  
  if (is.null(discard)){
    return(maf)
  }else {
    maf_filtered <- as.data.frame(maf[-discard, ])
    if (nrow(maf_filtered) == 0){
      message('No mutation left after Normal DP filtering.')
    }else{
      rownames(maf_filtered) <- 1:nrow(maf_filtered)
    }
    return(maf_filtered)
  }
  
}

